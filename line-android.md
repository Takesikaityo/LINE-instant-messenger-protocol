LINEインスタントメッセンジャープロトコル -  Androidバージョン
=================================================

Matti Virkkunen <mvirkkunen@gmail.com>

文書は2015-04-02（LINE 5.0.4）の時点で正確です。

このドキュメントではAndroidバージョンのLINEで使用されるカスタムプロトコルについて説明します。それは
それは主に違いを記述しているので、line-protocol.mdに付いてください。

概要
--------

LINEのAndroid版では、Apache Thriftをほとんどの場合のシリアライズ形式として使用しています
コミュニケーションしかし、大きな違いがあります。これにより、トータルのプロトコルスイートが
おそらく彼らの主な目標である、多くの帯域幅を節約します。モバイル
LINEのバージョンはデスクトップ版よりもはるかに多くのユーザーを持っているため、主に
それらを最適化する。

HTTPではなくSPDY
--------------------

Androidクライアントは、主にHTTPの代わりにSPDY（ドラフト2）を使用します。これには多くの利点があります。
複数のトランザクションとヘッダー圧縮に1つのTCPストリームを使用することができます。

カスタムSPDY暗号化
----------------------

SPDYは通常標準SSLを使用して暗号化されていますが、LINEは独自のカスタム暗号化を実装しています。彼らの
その理由は、SSLハンドシェイクとオーバーヘッドを排除するため、
モバイルデバイスとネットワークの負担の大きさ。

暗号化方式は、SPDY要求の本体部分のみを暗号化します。標準ヘッダー部分
SPDYの暗号化は暗号化されずに残されますが、本文に暗号化されたヘッダーもオプションで含めることができます。

クライアントがサーバーに接続すると、128ビットのランダムキーが生成され、RSAで暗号化されます
公開鍵で暗号化し、最初の要求でヘッダーとしてサーバーに送信します。このキーは両方で使用されます
クライアントとサーバーはCBCモードでAESを使用してボディを固定IVで暗号化します。 AESの文脈
メッセージごとにリセットされます。暗号解読者は固定IVと新しい
各メッセージのコンテキスト。

AESで暗号化されたメッセージは、legy_hmacというカスタムの32ビットHMACで署名されています。これは不思議です
ネイティブコードでのみ利用可能です。私はまだそれがどのように動作するか分析していない。私は、ネイティブ
ライブラリのアプローチは、プラットフォーム間でのコードの再利用を可能にするために、または追加する無駄な試みとして
暗黙のセキュリティ。これは、このハッシュアルゴリズムで構築されているようです：

https://github.com/Cyan4973/xxHash
興味深いことに、彼らは自分のアプリにxxHashの著作権表示を含めることを忘れてしまったようです。

(TODO)

(TODO アタッチ: RSA keyとAES IV)

(TODO サンプルコードの追加: カスタム暗号化)

(TODO サンプルコードの追加: legy_hmac実装)

認証
--------------
LINEのモバイル版では、ユーザーが手動でアカウントを登録する必要はありません。
アプリが最初にインストールされたときに自動的に生成されます。したがって、ユーザー認証方法は
また異なる。

Androidクライアントは、LINEサーバーに認証するために使用される15バイトの認証キーを格納します。
キーは暗号化された設定データベースに保存されますが、明らかに、アプリは
それを読んで、これは回避するのは簡単です（それは本質的に8ビットの暗号化キーを使用することが判明しますが、
電話機のANDROID_ID値から生成されます）。 authキーは、アプリが
最初にインストールされ、変更されていないようです。

tools / view-android-settings.pyスクリプトを使用して、アカウントの認証キーを表示することができます。それ
LINE設定のSQLiteデータベースと、オプションでANDROID_IDが必要です（これをブルートフォースすることもできます
現代のコンピュータでは約1ミリ秒かかる）。私の電話のデータベースは次の場所にあります：


/data/data/jp.naver.line.android/databases/naver_line

表示されたユーザMIDおよび認証キーは、クライアント
サーバーに接続します。

(TODO)

(TODO サンプルコードの追加: モバイル認証トークンの生成)

カスタムスリフトプロトコル
----------------------

カスタムプロトコルは、とりわけ、GUID（ユーザーIDとして使用されます。
システム）を文字列ではなくバイナリとして使用し、サイズを半分にします。

(TODO)

コンパクトメッセージプロトコル
------------------------
メッセージを送信するためのカスタムの、恐らく非リザーブのバイナリプロトコルがあります。

(TODO)
